# ============================================================
# NYASACV SECURITY CONFIGURATION
# Last Updated: 2025-12-26
# ============================================================

# ------------------------------
# SECURITY HEADERS
# ------------------------------
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"

    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Enable XSS protection
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Permissions policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # Remove server signature
    Header always unset X-Powered-By
    Header always unset Server
</IfModule>

# Disable server signature
ServerSignature Off

# ------------------------------
# REWRITE ENGINE
# ------------------------------
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    DirectoryIndex index.php

    # ===== CRITICAL: BLOCK .GIT DIRECTORY =====
    # This was the attack vector - NEVER allow .git access
    RewriteRule ^\.git - [F,L]
    RewriteRule \.git/ - [F,L]
    RewriteRule ^(.*/)?\.git(/.*)?$ - [F,L]

    # ===== BLOCK ALL HIDDEN FILES AND DIRECTORIES =====
    # Except .well-known (needed for SSL certificates)
    RewriteRule (^|/)\.(?!well-known(/|$)) - [F,L]

    # ===== BLOCK SENSITIVE DIRECTORIES =====
    RewriteRule ^app(/.*)?$ - [F,L]
    RewriteRule ^bootstrap(/.*)?$ - [F,L]
    RewriteRule ^config(/.*)?$ - [F,L]
    RewriteRule ^database(/.*)?$ - [F,L]
    RewriteRule ^resources(/.*)?$ - [F,L]
    RewriteRule ^routes(/.*)?$ - [F,L]
    RewriteRule ^storage(/.*)?$ - [F,L]
    RewriteRule ^tests(/.*)?$ - [F,L]
    RewriteRule ^vendor(/.*)?$ - [F,L]
    RewriteRule ^node_modules(/.*)?$ - [F,L]
    RewriteRule ^lang(/.*)?$ - [F,L]

    # ===== BLOCK SENSITIVE FILES =====
    RewriteRule ^\.env$ - [F,L]
    RewriteRule ^\.env\..*$ - [F,L]
    RewriteRule ^\.editorconfig$ - [F,L]
    RewriteRule ^\.gitignore$ - [F,L]
    RewriteRule ^\.gitattributes$ - [F,L]
    RewriteRule ^composer\.(json|lock)$ - [F,L]
    RewriteRule ^package(-lock)?\.json$ - [F,L]
    RewriteRule ^artisan$ - [F,L]
    RewriteRule ^phpunit\.xml$ - [F,L]
    RewriteRule ^phpstan\.neon$ - [F,L]
    RewriteRule ^webpack\.mix\.js$ - [F,L]
    RewriteRule ^vite\.config\.js$ - [F,L]
    RewriteRule ^tailwind\.config\.js$ - [F,L]
    RewriteRule ^postcss\.config\.js$ - [F,L]
    RewriteRule ^README\.md$ - [F,L]
    RewriteRule ^CHANGELOG\.md$ - [F,L]
    RewriteRule ^LICENSE$ - [F,L]
    RewriteRule ^Makefile$ - [F,L]
    RewriteRule ^docker-compose\.yml$ - [F,L]
    RewriteRule ^Dockerfile$ - [F,L]
    RewriteRule ^\.dockerignore$ - [F,L]

    # ===== BLOCK BACKUP AND LOG FILES =====
    RewriteRule ^.*\.(sql|sql\.gz|sql\.zip|bak|backup|old|orig|log|logs)$ - [F,L]
    RewriteRule ^.*\.(tar|tar\.gz|tgz|zip|rar|7z)$ - [F,L]

    # ===== BLOCK DANGEROUS PHP EXTENSIONS =====
    RewriteRule ^.*\.(phtml|pht|php3|php4|php5|php7|php8|phps|phar|inc)$ - [F,L]

    # ===== BLOCK COMMON SHELL/BACKDOOR FILENAMES =====
    RewriteRule ^(shell|c99|r57|c100|webshell|b374k|alfa|wso|mini|up|cmd|eval)\.php$ - [F,L]
    RewriteRule ^(config|configuration|conf|cfg|settings|setup|install|installer)\.php$ - [F,L]

    # ===== BLOCK WORDPRESS COMMON ATTACKS (even though not WP) =====
    RewriteRule ^wp-admin - [F,L]
    RewriteRule ^wp-includes - [F,L]
    RewriteRule ^wp-content - [F,L]
    RewriteRule ^wp-login\.php$ - [F,L]
    RewriteRule ^xmlrpc\.php$ - [F,L]

    # ===== LARAVEL ROUTING =====
    RewriteRule ^index\.php$ - [L]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.php [L]
</IfModule>

# ------------------------------
# BLOCK ACCESS TO SENSITIVE FILES
# ------------------------------
<FilesMatch "^\.">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

<FilesMatch "\.(env|gitignore|gitattributes|editorconfig|htaccess|htpasswd)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

<FilesMatch "\.(sql|sql\.gz|sql\.zip|bak|backup|old|orig|log|ini|sh|bash)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

# Block access to composer and package files
<FilesMatch "^(composer\.(json|lock)|package(-lock)?\.json|yarn\.lock)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

# ------------------------------
# DISABLE DIRECTORY LISTING
# ------------------------------
Options -Indexes -ExecCGI -Includes

# ------------------------------
# LIMIT REQUEST METHODS
# ------------------------------
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_METHOD} ^(TRACE|DELETE|TRACK|DEBUG|CONNECT) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# ------------------------------
# BLOCK BAD USER AGENTS (common scanners)
# ------------------------------
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} (havij|sqlmap|nikto|nessus|nmap|acunetix|w3af|burp|owasp|dirbuster|gobuster) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (bot|crawl|spider|slurp|scan|wget|curl|libwww) [NC]
    RewriteCond %{HTTP_USER_AGENT} !googlebot [NC]
    RewriteCond %{HTTP_USER_AGENT} !bingbot [NC]
    RewriteCond %{HTTP_USER_AGENT} !msnbot [NC]
    RewriteCond %{HTTP_USER_AGENT} !yandex [NC]
    RewriteRule .* - [F,L]
</IfModule>

# ------------------------------
# PREVENT HOTLINKING
# ------------------------------
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?nyasacv\.com [NC]
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?google\. [NC]
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?facebook\. [NC]
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?twitter\. [NC]
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?linkedin\. [NC]
    RewriteRule \.(jpg|jpeg|png|gif|webp|svg|css|js)$ - [F,L]
</IfModule>

# ------------------------------
# FILE UPLOAD RESTRICTIONS
# ------------------------------
<IfModule mod_php.c>
    php_flag engine off
</IfModule>

# Only allow PHP in index.php
<FilesMatch "^(?!index\.php$).+\.php$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

# Allow index.php
<Files "index.php">
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
</Files>

# php -- BEGIN cPanel-generated handler, do not edit
# Set the "ea-php82" package as the default "PHP" programming language.
<IfModule mime_module>
  AddHandler application/x-httpd-ea-php82 .php .php8 .phtml
</IfModule>
# php -- END cPanel-generated handler, do not edit
